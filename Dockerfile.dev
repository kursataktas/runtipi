ARG NODE_VERSION="iron"
ARG ALPINE_VERSION="3.20"

FROM node:${NODE_VERSION}-alpine${ALPINE_VERSION}

ARG DEBUG_MODE=false
ENV DEBUG_MODE=${DEBUG_MODE}

RUN echo "Debug mode is $DEBUG_MODE"

ENV LOCAL=true
ENV SENTRY_RELEASE=development

RUN apk add --no-cache python3 make g++
RUN apk add --no-cache curl openssl git

RUN npm install pnpm@9.4.0 pm2 -g

ARG TARGETARCH
ARG DOCKER_COMPOSE_VERSION="v2.29.2"
ENV TARGETARCH=${TARGETARCH}
ENV NODE_ENV="development"

# Dashboard
WORKDIR /app

RUN echo "Building for ${TARGETARCH}"

RUN if [ "${TARGETARCH}" = "arm64" ]; then \
  curl -L -o docker-binary "https://github.com/docker/compose/releases/download/$DOCKER_COMPOSE_VERSION/docker-compose-linux-aarch64"; \
  elif [ "${TARGETARCH}" = "amd64" ]; then \
  curl -L -o docker-binary "https://github.com/docker/compose/releases/download/$DOCKER_COMPOSE_VERSION/docker-compose-linux-x86_64"; \
  fi

RUN chmod +x docker-binary

RUN mv docker-binary /usr/local/bin/docker-compose

COPY ./pnpm-lock.yaml ./
RUN pnpm fetch --ignore-scripts

COPY ./package*.json ./
COPY ./packages/worker/package.json ./packages/worker/package.json
COPY ./packages/shared/package.json ./packages/shared/package.json
COPY ./packages/db/package.json ./packages/db/package.json
COPY ./packages/cache/package.json ./packages/cache/package.json

COPY ./scripts ./scripts
COPY ./public ./public

RUN pnpm install -r --prefer-offline 

COPY ./packages ./packages

COPY ./packages/db/assets/migrations ./packages/worker/assets/migrations
COPY ./tsconfig.json ./tsconfig.json
COPY ./next.config.mjs ./next.config.mjs

# Sentry
COPY ./sentry.client.config.ts ./sentry.client.config.ts

COPY ./start.dev.sh ./start.sh

EXPOSE 3000 5000 5001 9229

RUN echo "Debug mode is $DEBUG_MODE"
# Copy the appropriate nodemon configuration based on DEBUG_MODE
RUN if [ "$DEBUG_MODE" = "true" ]; then \
  echo "Debug mode is enabled" \
  && rm -f ./packages/worker/nodemon.json \
  && cp ./packages/worker/nodemon.debug.json ./packages/worker/nodemon.json; \
  fi

CMD ["sh", "start.sh"]